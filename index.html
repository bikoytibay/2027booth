<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dela Cruz 2027 New Year Photobooth</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts for premium typography -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --new-year-gold: #FFD700;
            --new-year-silver: #C0C0C0;
            --new-year-blue: #1E3A8A;
            --new-year-purple: #7C3AED;
            --new-year-red: #DC2626;
            --new-year-green: #10B981;
            --premium-gold: #D4AF37;
            --premium-silver: #A8A8A8;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a2b5a 50%, #3a1b6a 100%);
            color: white;
            min-height: 100vh;
            padding-bottom: 2rem;
            overflow-x: hidden;
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile-first improvements */
        .container {
            padding-left: 12px;
            padding-right: 12px;
            max-width: 100%;
        }
        
        .header {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(30, 58, 138, 0.85) 100%);
            padding: 1rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            margin-bottom: 1rem;
            border-bottom: 3px solid var(--premium-gold);
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                var(--premium-gold) 0%, 
                var(--premium-silver) 25%, 
                var(--new-year-red) 50%, 
                var(--premium-silver) 75%, 
                var(--premium-gold) 100%);
            z-index: 2;
        }
        
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            color: var(--premium-gold);
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.5);
            font-size: clamp(1.4rem, 5vw, 2rem);
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        
        .header .year {
            color: var(--premium-silver);
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            display: inline-block;
            font-size: clamp(0.8rem, 3vw, 0.95rem);
            font-weight: 600;
            border: 1px solid rgba(212, 175, 55, 0.3);
            margin-bottom: 0.5rem;
        }
        
        .camera-container {
            background: linear-gradient(135deg, #111 0%, #222 100%);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
            margin-bottom: 1rem;
            position: relative;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        #camera-view {
            width: 100%;
            height: 55vh;
            min-height: 350px;
            max-height: 500px;
            object-fit: cover;
            display: block;
            transform: scaleX(1);
            background: #000;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        
        .premium-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
            background: 
                linear-gradient(90deg, rgba(212, 175, 55, 0.1) 1px, transparent 1px) 0 0 / 15px 15px,
                linear-gradient(rgba(212, 175, 55, 0.1) 1px, transparent 1px) 0 0 / 15px 15px;
        }
        
        .celebration-text {
            position: absolute;
            top: 10%;
            left: 0;
            width: 100%;
            text-align: center;
            font-family: 'Dancing Script', cursive;
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            color: var(--premium-gold);
            text-shadow: 0 2px 10px rgba(212, 175, 55, 0.7);
            z-index: 5;
            padding: 0 10px;
            animation: gentleGlow 3s infinite alternate;
            letter-spacing: 1px;
            line-height: 1.2;
        }
        
        .year-display {
            position: absolute;
            bottom: 15%;
            right: 8%;
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 7vw, 3.2rem);
            color: var(--premium-gold);
            text-shadow: 0 2px 15px rgba(212, 175, 55, 0.8);
            z-index: 5;
            font-weight: 700;
            transform: rotate(-5deg);
            background: linear-gradient(45deg, rgba(0, 0, 0, 0.7) 0%, transparent 70%);
            padding: 8px 16px;
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.4);
        }
        
        @keyframes gentleGlow {
            0% {
                text-shadow: 0 2px 10px rgba(212, 175, 55, 0.7);
                transform: scale(1);
            }
            100% {
                text-shadow: 0 2px 18px rgba(212, 175, 55, 0.9), 
                             0 0 30px rgba(255, 215, 0, 0.5);
                transform: scale(1.02);
            }
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 3;
            box-shadow: 0 0 15px currentColor;
        }
        
        .firework-burst {
            position: absolute;
            width: 0;
            height: 0;
            border-radius: 50%;
            pointer-events: none;
            z-index: 3;
            border: 2px solid;
        }
        
        /* Improved camera controls for mobile */
        .camera-controls {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.95) 100%);
            padding: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--new-year-red) 0%, #8B0000 100%);
            border: 3px solid var(--premium-gold);
            color: white;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.8), 
                        0 0 20px rgba(212, 175, 55, 0.4) inset;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .capture-btn::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
        }
        
        .capture-btn:active {
            transform: scale(0.92);
            box-shadow: 0 2px 10px rgba(220, 38, 38, 0.6), 
                        0 0 15px rgba(212, 175, 55, 0.3) inset;
        }
        
        .secondary-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            font-size: 1.1rem;
            backdrop-filter: blur(5px);
            flex-shrink: 0;
        }
        
        .secondary-btn:active {
            transform: scale(0.92);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
        }
        
        .photo-counter {
            background: linear-gradient(135deg, var(--new-year-blue) 0%, var(--new-year-purple) 100%);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            min-width: 120px;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 3px 10px rgba(30, 58, 138, 0.4);
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        /* Mobile-optimized sidebar */
        .mobile-sidebar {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(30, 58, 138, 0.8) 100%);
            border-radius: 15px;
            margin-bottom: 1rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .mobile-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--premium-gold) 20%, 
                var(--premium-silver) 50%, 
                var(--premium-gold) 80%, 
                transparent 100%);
            z-index: 1;
        }
        
        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        .sidebar-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            color: var(--premium-gold);
            border-bottom: 2px solid var(--premium-gold);
            padding-bottom: 0.6rem;
            margin-bottom: 1rem;
            font-weight: 700;
            font-size: clamp(1rem, 4vw, 1.3rem);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.5px;
        }
        
        /* Mobile-optimized grids */
        .mobile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-bottom: 0.8rem;
        }
        
        .mobile-option {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 12px;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            min-height: 110px;
            justify-content: center;
        }
        
        .mobile-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mobile-option:active {
            transform: scale(0.96);
        }
        
        .mobile-option.active {
            border-color: var(--premium-gold);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.05) 100%);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }
        
        .mobile-option.active::before {
            opacity: 1;
        }
        
        /* FIXED: Layout preview styles */
        .layout-preview {
            height: 80px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            display: grid;
            gap: 2px;
            padding: 2px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .layout-2x2 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        
        .layout-1x4 {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 1fr;
        }
        
        .layout-3-1 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 2fr 1fr;
        }
        
        .layout-1-3 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr 2fr;
        }
        
        .layout-cell {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .layout-cell.filled {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            border: 2px solid var(--premium-gold);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
        }
        
        .option-name {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.2;
        }
        
        .overlay-preview {
            height: 80px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 0.6rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(212, 175, 55, 0.3);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        .overlay-preview-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .overlay-fireworks {
            background: radial-gradient(circle, rgba(212, 175, 55, 0.3) 0%, rgba(0, 0, 0, 0.9) 70%);
        }
        
        .overlay-confetti {
            background: linear-gradient(45deg, rgba(212, 175, 55, 0.2) 0%, rgba(30, 58, 138, 0.2) 100%);
        }
        
        .overlay-gold {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.4) 0%, rgba(255, 165, 0, 0.4) 100%);
        }
        
        .overlay-sparkle {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(124, 58, 237, 0.4) 100%);
        }
        
        .overlay-icon {
            font-size: 2rem;
            color: var(--premium-gold);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
        }
        
        .filter-preview {
            height: 60px;
            width: 100%;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .filter-none {
            background: linear-gradient(135deg, #f5f5f5 0%, #d4d4d4 100%);
        }
        
        .filter-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        .filter-silver {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
        }
        
        .filter-sparkle {
            background: linear-gradient(135deg, #7C3AED 0%, #3B82F6 100%);
        }
        
        .filter-fireworks {
            background: linear-gradient(135deg, #DC2626 0%, #F59E0B 100%);
        }
        
        .filter-festive {
            background: linear-gradient(135deg, #1E3A8A 0%, #7C3AED 100%);
        }
        
        /* Collage display - FIXED for proper rendering */
        .photo-collage {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(30, 58, 138, 0.85) 100%);
            border-radius: 15px;
            padding: 1.2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8);
            margin-bottom: 1.5rem;
            display: none;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(212, 175, 55, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .photo-collage.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* FIXED: Collage display styles */
        .collage-display {
            height: 50vh;
            min-height: 350px;
            max-height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: grid;
            gap: 6px;
            padding: 6px;
            margin-bottom: 1.2rem;
            border: 2px solid rgba(212, 175, 55, 0.4);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.7);
        }
        
        /* Dynamic collage layouts */
        .collage-layout-2x2 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        
        .collage-layout-1x4 {
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 1fr;
        }
        
        .collage-layout-3-1 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 2fr 1fr;
        }
        
        .collage-layout-1-3 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr 2fr;
        }
        
        .collage-cell {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        .cell-number {
            position: absolute;
            top: 8px;
            right: 8px;
            background: radial-gradient(circle, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.7) 100%);
            color: var(--premium-gold);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            border: 2px solid var(--premium-gold);
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        /* Improved action buttons for mobile */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 100%;
        }
        
        .action-btn {
            padding: 1rem 1.5rem;
            border-radius: 40px;
            font-weight: 700;
            border: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            font-size: 1rem;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            width: 100%;
            min-height: 56px;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s;
        }
        
        .action-btn:hover::before {
            left: 100%;
        }
        
        .action-btn:active {
            transform: scale(0.96);
        }
        
        .download-btn {
            background: linear-gradient(135deg, var(--premium-gold) 0%, #B8860B 100%);
            color: #000;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .download-btn:active {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
        }
        
        .reset-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            color: white;
            border: 1px solid rgba(212, 175, 55, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .reset-btn:active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
        }
        
        .countdown {
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            color: var(--premium-gold);
            font-weight: 700;
            text-align: center;
            padding: 0.8rem;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(30, 58, 138, 0.6) 100%);
            border-radius: 12px;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            flex-wrap: wrap;
            border: 1px solid rgba(212, 175, 55, 0.3);
            font-family: 'Montserrat', sans-serif;
            line-height: 1.3;
        }
        
        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.5) 100%);
            opacity: 0;
            z-index: 10;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .camera-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 65%;
            border: 2px dashed var(--premium-gold);
            border-radius: 10px;
            z-index: 1;
            pointer-events: none;
            opacity: 0.7;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .footer {
            text-align: center;
            margin-top: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            padding: 0 1rem;
            font-family: 'Montserrat', sans-serif;
            line-height: 1.4;
        }
        
        /* Toast notification - mobile optimized */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 58, 138, 0.95) 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 4px solid var(--premium-gold);
            max-width: 90%;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            text-align: center;
            font-size: 0.95rem;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Premium frame decorations */
        .frame-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            z-index: 4;
            pointer-events: none;
        }
        
        .corner-tl {
            top: 8px;
            left: 8px;
            border-top: 2px solid var(--premium-gold);
            border-left: 2px solid var(--premium-gold);
        }
        
        .corner-tr {
            top: 8px;
            right: 8px;
            border-top: 2px solid var(--premium-gold);
            border-right: 2px solid var(--premium-gold);
        }
        
        .corner-bl {
            bottom: 8px;
            left: 8px;
            border-bottom: 2px solid var(--premium-gold);
            border-left: 2px solid var(--premium-gold);
        }
        
        .corner-br {
            bottom: 8px;
            right: 8px;
            border-bottom: 2px solid var(--premium-gold);
            border-right: 2px solid var(--premium-gold);
        }
        
        /* Loading indicator */
        .camera-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            color: var(--premium-gold);
            width: 100%;
            padding: 0 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-top: 4px solid var(--premium-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile tap highlight fix */
        .btn-tap-fix {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Scroll indicator for mobile */
        .scroll-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--premium-gold);
            font-size: 1.5rem;
            animation: bounce 2s infinite;
            z-index: 10;
            opacity: 0.7;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-10px);}
            60% {transform: translateX(-50%) translateY(-5px);}
        }
        
        /* Instructions - mobile optimized */
        .mobile-instructions {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(30, 58, 138, 0.08) 100%);
            border: 1px solid rgba(212, 175, 55, 0.25);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .instruction-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .instruction-badge {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(30, 58, 138, 0.2) 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .header {
                padding: 0.8rem;
                margin-bottom: 0.8rem;
            }
            
            #camera-view {
                height: 50vh;
                min-height: 300px;
                max-height: 450px;
            }
            
            .camera-controls {
                padding: 0.7rem;
                gap: 0.4rem;
            }
            
            .capture-btn {
                width: 65px;
                height: 65px;
                font-size: 1.5rem;
            }
            
            .secondary-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .photo-counter {
                min-width: 110px;
                font-size: 0.85rem;
                padding: 0.5rem 0.8rem;
            }
            
            .mobile-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
            }
            
            .mobile-option {
                padding: 0.7rem;
                min-height: 100px;
            }
            
            .collage-display {
                height: 45vh;
                min-height: 300px;
                max-height: 400px;
            }
            
            .action-btn {
                padding: 0.9rem 1.2rem;
                font-size: 0.95rem;
                min-height: 52px;
            }
            
            .year-display {
                bottom: 12%;
                right: 5%;
                font-size: clamp(1.8rem, 6vw, 2.8rem);
                padding: 6px 12px;
            }
            
            .celebration-text {
                top: 8%;
                font-size: clamp(1.6rem, 5vw, 2.2rem);
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding-left: 8px;
                padding-right: 8px;
            }
            
            #camera-view {
                min-height: 280px;
                max-height: 400px;
            }
            
            .capture-btn {
                width: 60px;
                height: 60px;
                font-size: 1.3rem;
            }
            
            .secondary-btn {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
            
            .photo-counter {
                min-width: 100px;
                font-size: 0.8rem;
                padding: 0.4rem 0.7rem;
            }
            
            .mobile-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .mobile-option {
                min-height: 95px;
            }
            
            .layout-preview, .overlay-preview {
                height: 70px;
            }
            
            .filter-preview {
                height: 55px;
            }
            
            .collage-display {
                min-height: 280px;
                max-height: 350px;
            }
            
            .section-title {
                font-size: clamp(0.95rem, 3.5vw, 1.2rem);
            }
            
            .action-btn {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
                min-height: 48px;
            }
            
            .instruction-badge {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
            
            .year-display {
                bottom: 10%;
                right: 4%;
                font-size: clamp(1.6rem, 5vw, 2.4rem);
            }
            
            .celebration-text {
                top: 6%;
                font-size: clamp(1.4rem, 4vw, 2rem);
            }
        }
        
        @media (max-width: 360px) {
            #camera-view {
                min-height: 250px;
            }
            
            .capture-btn {
                width: 55px;
                height: 55px;
            }
            
            .secondary-btn {
                width: 35px;
                height: 35px;
            }
            
            .mobile-option {
                min-height: 90px;
                padding: 0.6rem;
            }
            
            .collage-display {
                min-height: 250px;
            }
            
            .action-btn {
                padding: 0.7rem 0.9rem;
                font-size: 0.85rem;
            }
        }
        
        /* Print overlay styles */
        .print-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .overlay-fireworks-print {
            background: radial-gradient(circle, rgba(212, 175, 55, 0.12) 0%, transparent 70%);
        }
        
        .overlay-confetti-print {
            background: linear-gradient(45deg, rgba(212, 175, 55, 0.08) 0%, rgba(30, 58, 138, 0.08) 100%);
        }
        
        .overlay-gold-print {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(255, 165, 0, 0.15) 100%);
        }
        
        .overlay-sparkle-print {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, rgba(124, 58, 237, 0.08) 100%);
        }
        
        /* Better scrolling on iOS */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        
        /* Hide scrollbar for cleaner look */
        .hide-scrollbar {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Mobile navigation hints */
        .nav-hint {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        /* Fix for image rendering */
        .image-fix {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }
        
        /* 4x6 aspect ratio guide */
        .aspect-ratio-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 52.5%; /* 4:6 = 2:3 aspect ratio */
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 5px;
            z-index: 1;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="scroll-container hide-scrollbar">
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header text-center">
            <h1><i class="fas fa-crown me-2"></i>Dela Cruz 2027 Photobooth</h1>
            <div class="year">
                <i class="fas fa-star me-2"></i>Premium New Year Celebration
            </div>
            <div class="countdown">
                <i class="fas fa-clock me-2"></i>2027 Countdown: <span id="countdown-timer">Loading...</span>
            </div>
        </div>
        
        <!-- Camera Section -->
        <div class="camera-container">
            <div class="aspect-ratio-guide" id="aspect-ratio-guide"></div>
            <div class="premium-frame"></div>
            <div class="frame-corner corner-tl"></div>
            <div class="frame-corner corner-tr"></div>
            <div class="frame-corner corner-bl"></div>
            <div class="frame-corner corner-br"></div>
            
            <video id="camera-view" autoplay playsinline></video>
            <div class="camera-overlay" id="camera-overlay">
                <div class="celebration-text" id="celebration-text">Happy New Year</div>
                <div class="year-display" id="year-display">2027</div>
            </div>
            <div class="flash-effect" id="flash-effect"></div>
            
            <!-- Scroll indicator -->
            <div class="scroll-indicator" id="scroll-indicator">
                <i class="fas fa-chevron-down"></i>
            </div>
            
            <div class="camera-controls">
                <div class="secondary-btn btn-tap-fix" id="switch-camera" title="Switch Camera">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="photo-counter">
                    <i class="fas fa-camera me-2"></i> 
                    <span id="photo-counter-text">0/4 Photos</span>
                </div>
                <div class="capture-btn btn-tap-fix" id="capture-btn">
                    <i class="fas fa-camera"></i>
                </div>
                <div class="secondary-btn btn-tap-fix" id="toggle-flash" title="Toggle Flash">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="secondary-btn btn-tap-fix" id="toggle-grid" title="Toggle Grid">
                    <i class="fas fa-th"></i>
                </div>
            </div>
        </div>
        
        <!-- Mobile Sidebar (replaces desktop sidebar) -->
        <div class="mobile-sidebar">
            <!-- Overlays Section -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-gem me-2"></i>Premium Overlays</h3>
                <div class="mobile-grid" id="overlays-grid">
                    <!-- Overlays will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Filters Section -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-palette me-2"></i>Photo Filters</h3>
                <div class="mobile-grid" id="filters-grid">
                    <!-- Filters will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Layouts Section -->
            <div class="sidebar-section">
                <h3 class="section-title"><i class="fas fa-th-large me-2"></i>Collage Layouts</h3>
                <div class="mobile-grid" id="collage-layouts">
                    <!-- Layouts will be generated by JavaScript -->
                </div>
            </div>
            
            <div class="nav-hint">
                <i class="fas fa-hand-pointer me-1"></i> Tap options to customize your photos
            </div>
        </div>
        
        <!-- Photo Collage Display -->
        <div class="photo-collage" id="photo-collage">
            <h3 class="section-title"><i class="fas fa-trophy me-2"></i>Your Premium 2027 Collage</h3>
            <div class="collage-display" id="collage-display">
                <!-- Collage cells will be generated by JavaScript -->
            </div>
            <div class="action-buttons">
                <button class="action-btn download-btn btn-tap-fix" id="download-btn">
                    <i class="fas fa-download"></i> Download Premium Collage
                </button>
                <button class="action-btn reset-btn btn-tap-fix" id="reset-btn">
                    <i class="fas fa-sync-alt"></i> Start New Photoshoot
                </button>
            </div>
        </div>
        
        <!-- Mobile Instructions -->
        <div class="mobile-instructions">
            <h6 class="d-flex align-items-center mb-2" style="color: var(--premium-gold);">
                <i class="fas fa-graduation-cap me-2"></i>How to Use:
            </h6>
            <div class="instruction-badges">
                <span class="instruction-badge">
                    <i class="fas fa-camera me-1"></i> Allow Camera
                </span>
                <span class="instruction-badge">
                    <i class="fas fa-gem me-1"></i> Choose Overlay
                </span>
                <span class="instruction-badge">
                    <i class="fas fa-palette me-1"></i> Select Filter
                </span>
                <span class="instruction-badge">
                    <i class="fas fa-th-large me-1"></i> Pick Layout
                </span>
                <span class="instruction-badge">
                    <i class="fas fa-download me-1"></i> Download & Print
                </span>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p class="mb-1"><i class="fas fa-star me-1" style="color: var(--premium-gold);"></i> Create lasting memories with Dela Cruz 2027 Photobooth</p>
            <p class="mb-0 small">Designed with <i class="fas fa-heart text-danger"></i> for premium New Year celebrations</p>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let cameraStream = null;
        let facingMode = 'user';
        let flashOn = false;
        let gridVisible = true;
        let currentFilter = 'none';
        let currentLayout = '2x2';
        let currentOverlay = 'fireworks';
        let capturedPhotos = [];
        let photoCount = 0;
        let fireworksInterval = null;
        let cameraReady = false;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let isAndroid = /Android/.test(navigator.userAgent);
        
        // DOM Elements
        const cameraView = document.getElementById('camera-view');
        const captureBtn = document.getElementById('capture-btn');
        const switchCameraBtn = document.getElementById('switch-camera');
        const toggleFlashBtn = document.getElementById('toggle-flash');
        const toggleGridBtn = document.getElementById('toggle-grid');
        const photoCounterText = document.getElementById('photo-counter-text');
        const collageDisplay = document.getElementById('collage-display');
        const photoCollage = document.getElementById('photo-collage');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtn = document.getElementById('reset-btn');
        const flashEffect = document.getElementById('flash-effect');
        const aspectRatioGuide = document.getElementById('aspect-ratio-guide');
        const toast = document.getElementById('toast');
        const celebrationText = document.getElementById('celebration-text');
        const yearDisplay = document.getElementById('year-display');
        const cameraOverlay = document.getElementById('camera-overlay');
        const scrollIndicator = document.getElementById('scroll-indicator');
        
        // Enhanced show toast notification
        function showToast(message, duration = 2500) {
            // Cancel any existing toast timeout
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
            }
            
            toast.textContent = message;
            toast.classList.add('show');
            
            window.toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // New Year 2027 countdown
        function updateCountdown() {
            const now = new Date();
            const newYear2027 = new Date('January 1, 2027 00:00:00');
            const timeDiff = newYear2027 - now;
            
            if (timeDiff > 0) {
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                document.getElementById('countdown-timer').textContent = 
                    `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else {
                document.getElementById('countdown-timer').textContent = "Happy New Year 2027!";
            }
        }
        
        // Create fireworks animation
        function createFireworks() {
            const existingFireworks = cameraOverlay.querySelectorAll('.firework, .firework-burst');
            existingFireworks.forEach(fw => fw.remove());
            
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createFirework();
                }, i * 300);
            }
        }
        
        function createFirework() {
            const firework = document.createElement('div');
            firework.className = 'firework';
            
            const x = Math.random() * 85 + 7.5;
            const y = Math.random() * 85 + 7.5;
            
            const colors = ['#D4AF37', '#FFD700', '#FF6347', '#1E90FF', '#32CD32'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            firework.style.left = `${x}%`;
            firework.style.top = `${y}%`;
            firework.style.backgroundColor = color;
            firework.style.boxShadow = `0 0 20px ${color}`;
            
            cameraOverlay.appendChild(firework);
            
            firework.animate([
                { width: '6px', height: '6px', opacity: 1 },
                { width: '3px', height: '3px', opacity: 0.8 },
                { width: '1px', height: '1px', opacity: 0 }
            ], {
                duration: 800,
                easing: 'ease-out'
            });
            
            setTimeout(() => {
                createFireworkBurst(x, y, color);
                firework.remove();
            }, 700);
        }
        
        function createFireworkBurst(x, y, color) {
            const burst = document.createElement('div');
            burst.className = 'firework-burst';
            burst.style.left = `${x}%`;
            burst.style.top = `${y}%`;
            burst.style.borderColor = color;
            burst.style.boxShadow = `0 0 35px ${color}`;
            
            cameraOverlay.appendChild(burst);
            
            burst.animate([
                { width: '0px', height: '0px', opacity: 1 },
                { width: '120px', height: '120px', opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            });
            
            setTimeout(() => {
                burst.remove();
            }, 1000);
        }
        
        // Initialize camera - Fixed for iOS and GitHub Pages
        async function initCamera() {
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Show loading indicator
                cameraView.innerHTML = `
                    <div class="camera-loading">
                        <div class="spinner"></div>
                        <p>Loading camera...</p>
                    </div>
                `;
                
                // Check if we're on HTTPS (required for camera access)
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    cameraView.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <i class="fas fa-exclamation-triangle fa-3x mb-2" style="color: var(--premium-gold);"></i>
                            <p class="mb-2 text-center px-3" style="font-size: 1rem;">HTTPS Required</p>
                            <p class="mb-3 small text-center px-3" style="color: rgba(255,255,255,0.7);">
                                Camera access requires HTTPS. Please open this page via:<br>
                                https://your-username.github.io/repository-name
                            </p>
                        </div>
                    `;
                    showToast('Camera requires HTTPS connection', 5000);
                    return;
                }
                
                // Check if getUserMedia is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    cameraView.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <i class="fas fa-exclamation-circle fa-3x mb-2" style="color: var(--premium-gold);"></i>
                            <p class="mb-2 text-center px-3" style="font-size: 1rem;">Camera Not Supported</p>
                            <p class="mb-3 small text-center px-3" style="color: rgba(255,255,255,0.7);">
                                Your browser does not support camera access. Try using Chrome, Firefox, or Safari.
                            </p>
                        </div>
                    `;
                    showToast('Camera not supported in this browser', 4000);
                    return;
                }
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                // Try to get user media
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Set the stream to the video element
                cameraView.srcObject = cameraStream;
                
                // Handle iOS autoplay restrictions
                const playPromise = cameraView.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        cameraReady = true;
                        startFireworksAnimation();
                        showToast('Camera activated! Ready for your photoshoot.', 2000);
                        
                        // Hide loading
                        cameraView.innerHTML = '';
                        
                        // Hide scroll indicator after 3 seconds
                        setTimeout(() => {
                            if (scrollIndicator) {
                                scrollIndicator.style.display = 'none';
                            }
                        }, 3000);
                        
                    }).catch(e => {
                        console.error('Error playing video:', e);
                        showToast('Tap the screen to start camera', 3000);
                        
                        // Add a manual play trigger for iOS
                        document.body.addEventListener('touchstart', function startCameraOnTouch() {
                            cameraView.play().then(() => {
                                cameraReady = true;
                                startFireworksAnimation();
                                cameraView.innerHTML = '';
                                document.body.removeEventListener('touchstart', startCameraOnTouch);
                                showToast('Camera started!', 1500);
                                
                                // Hide scroll indicator
                                if (scrollIndicator) {
                                    scrollIndicator.style.display = 'none';
                                }
                            });
                        }, { once: true });
                    });
                }
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                
                cameraView.style.background = 'linear-gradient(135deg, #111 0%, #222 100%)';
                cameraView.innerHTML = 
                    '<div class="d-flex flex-column align-items-center justify-content-center h-100">' +
                    '<i class="fas fa-camera-slash fa-3x mb-2" style="color: var(--premium-gold);"></i>' +
                    '<p class="mb-2 text-center px-3" style="font-size: 1rem;">Camera access is required</p>' +
                    '<p class="mb-3 small text-center px-3" style="color: rgba(255,255,255,0.7);">Please allow camera permissions in your browser settings</p>' +
                    '<button class="btn btn-gold mt-1" onclick="initCamera()" style="background: linear-gradient(135deg, var(--premium-gold) 0%, #B8860B 100%); color: black; font-weight: bold; padding: 0.6rem 1.2rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); font-size: 0.9rem;">' +
                    '<i class="fas fa-camera me-2"></i>Enable Camera' +
                    '</button>' +
                    '</div>';
                
                showToast('Camera access required for photobooth experience.', 4000);
            }
        }
        
        // Start fireworks animation
        function startFireworksAnimation() {
            if (fireworksInterval) {
                clearInterval(fireworksInterval);
            }
            
            if (currentOverlay === 'fireworks') {
                createFireworks();
                fireworksInterval = setInterval(createFireworks, 2500);
            } else if (currentOverlay === 'confetti') {
                createConfetti();
                fireworksInterval = setInterval(createConfetti, 1800);
            } else {
                const existingFireworks = cameraOverlay.querySelectorAll('.firework, .firework-burst');
                existingFireworks.forEach(fw => fw.remove());
                if (fireworksInterval) {
                    clearInterval(fireworksInterval);
                    fireworksInterval = null;
                }
            }
        }
        
        // Create confetti animation
        function createConfetti() {
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'firework';
                confetti.style.fontSize = '20px';
                confetti.textContent = ['', '', '', '', '', ''][Math.floor(Math.random() * 6)];
                
                const x = Math.random() * 100;
                const startY = -10;
                
                confetti.style.left = `${x}%`;
                confetti.style.top = `${startY}%`;
                confetti.style.color = ['#D4AF37', '#FFD700', '#FF6347', '#1E90FF'][Math.floor(Math.random() * 4)];
                
                cameraOverlay.appendChild(confetti);
                
                const duration = 2000 + Math.random() * 1500;
                confetti.animate([
                    { transform: `translateY(0px) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(110vh) rotate(${360 + Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
                });
                
                setTimeout(() => {
                    confetti.remove();
                }, duration);
            }
        }
        
        // Capture photo with perfect 4x6 aspect ratio - UPDATED
        function capturePhoto() {
            if (!cameraReady) {
                showToast('Camera is not ready yet. Please wait...', 2000);
                return;
            }
            
            if (photoCount >= 4) {
                showToast('You have captured 4 photos! Reset to take more.', 2000);
                return;
            }
            
            // Check if video is playing and has valid dimensions
            if (!cameraView.videoWidth || !cameraView.videoHeight || cameraView.videoWidth === 0 || cameraView.videoHeight === 0) {
                showToast('Camera not ready. Please try again.', 2000);
                return;
            }
            
            // Visual feedback
            flashEffect.style.opacity = '0.9';
            setTimeout(() => {
                flashEffect.style.opacity = '0';
            }, 200);
            
            // Vibrate if available (mobile devices)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            const canvas = document.createElement('canvas');
            // 4x6 aspect ratio at high resolution for print quality
            canvas.width = 2400;  // 4 inches * 600 DPI
            canvas.height = 3600; // 6 inches * 600 DPI
            
            const context = canvas.getContext('2d');
            
            // Calculate source dimensions to maintain 4x6 aspect ratio without stretching
            const sourceAspect = cameraView.videoWidth / cameraView.videoHeight;
            const targetAspect = 4/6; // 4x6 aspect ratio
            
            let sourceX = 0;
            let sourceY = 0;
            let sourceWidth = cameraView.videoWidth;
            let sourceHeight = cameraView.videoHeight;
            
            if (sourceAspect > targetAspect) {
                // Source is wider than target aspect ratio
                sourceHeight = cameraView.videoHeight;
                sourceWidth = sourceHeight * targetAspect;
                sourceX = (cameraView.videoWidth - sourceWidth) / 2;
            } else {
                // Source is taller than target aspect ratio
                sourceWidth = cameraView.videoWidth;
                sourceHeight = sourceWidth / targetAspect;
                sourceY = (cameraView.videoHeight - sourceHeight) / 2;
            }
            
            // Draw the video frame centered and cropped to 4x6 ratio WITHOUT stretching
            context.drawImage(
                cameraView, 
                sourceX, sourceY, sourceWidth, sourceHeight,  // Source rectangle (cropped)
                0, 0, canvas.width, canvas.height              // Destination rectangle (full canvas)
            );
            
            // Apply selected filter
            applyFilterToCanvas(context, canvas.width, canvas.height);
            
            // Apply selected overlay to the captured photo
            applyOverlayToCanvas(context, canvas.width, canvas.height);
            
            // Add premium frame effect
            context.strokeStyle = '#D4AF37';
            context.lineWidth = 20;
            context.strokeRect(30, 30, canvas.width - 60, canvas.height - 60);
            
            // Add corner decorations
            const cornerSize = 60;
            context.strokeStyle = '#D4AF37';
            context.lineWidth = 8;
            
            // Top-left corner
            context.beginPath();
            context.moveTo(30, 30 + cornerSize);
            context.lineTo(30, 30);
            context.lineTo(30 + cornerSize, 30);
            context.stroke();
            
            // Top-right corner
            context.beginPath();
            context.moveTo(canvas.width - 30 - cornerSize, 30);
            context.lineTo(canvas.width - 30, 30);
            context.lineTo(canvas.width - 30, 30 + cornerSize);
            context.stroke();
            
            // Bottom-left corner
            context.beginPath();
            context.moveTo(30, canvas.height - 30 - cornerSize);
            context.lineTo(30, canvas.height - 30);
            context.lineTo(30 + cornerSize, canvas.height - 30);
            context.stroke();
            
            // Bottom-right corner
            context.beginPath();
            context.moveTo(canvas.width - 30 - cornerSize, canvas.height - 30);
            context.lineTo(canvas.width - 30, canvas.height - 30);
            context.lineTo(canvas.width - 30, canvas.height - 30 - cornerSize);
            context.stroke();
            
            // Add "Happy New Year" text with optimized positioning
            context.font = 'bold 140px "Dancing Script", cursive';
            context.fillStyle = '#D4AF37';
            context.textAlign = 'center';
            context.shadowColor = 'rgba(0, 0, 0, 0.7)';
            context.shadowBlur = 15;
            context.fillText('Happy New Year', canvas.width / 2, 300);
            context.shadowBlur = 0;
            
            // Add "2027" text
            context.font = 'bold 180px "Playfair Display", serif';
            context.fillStyle = '#D4AF37';
            context.textAlign = 'center';
            context.shadowColor = 'rgba(0, 0, 0, 0.7)';
            context.shadowBlur = 20;
            context.fillText('2027', canvas.width / 2, canvas.height - 200);
            context.shadowBlur = 0;
            
            // Add photo number with premium design
            context.fillStyle = 'rgba(0, 0, 0, 0.6)';
            context.beginPath();
            context.arc(100, 100, 50, 0, Math.PI * 2);
            context.fill();
            
            context.font = 'bold 40px Arial';
            context.fillStyle = '#D4AF37';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(photoCount + 1, 100, 100);
            
            // Add decorative element
            context.font = '60px Arial';
            context.fillStyle = '#D4AF37';
            context.fillText('', 100, 180);
            
            // Convert to data URL - Use JPEG for better compatibility
            let photoData;
            try {
                // High quality for print
                photoData = canvas.toDataURL('image/jpeg', 0.92);
            } catch (e) {
                console.error('Error converting canvas to data URL:', e);
                photoData = canvas.toDataURL('image/jpeg', 0.85);
            }
            
            // Add to captured photos array
            capturedPhotos.push({
                data: photoData,
                filter: currentFilter,
                overlay: currentOverlay,
                timestamp: new Date().toLocaleTimeString(),
                width: canvas.width,
                height: canvas.height
            });
            
            photoCount++;
            
            // Update UI
            updateCaptureUI();
            showToast(`Photo ${photoCount} captured! ${4 - photoCount} remaining.`);
            
            // If we have 4 photos, show collage
            if (photoCount >= 4) {
                setTimeout(showCollage, 500);
            }
        }
        
        // Apply filter to canvas
        function applyFilterToCanvas(context, width, height) {
            context.globalCompositeOperation = 'overlay';
            
            switch(currentFilter) {
                case 'gold':
                    context.fillStyle = 'rgba(212, 175, 55, 0.15)';
                    context.fillRect(0, 0, width, height);
                    break;
                case 'silver':
                    context.fillStyle = 'rgba(192, 192, 192, 0.15)';
                    context.fillRect(0, 0, width, height);
                    break;
                case 'sparkle':
                    for (let i = 0; i < 50; i++) {
                        const x = Math.random() * width;
                        const y = Math.random() * height;
                        const radius = Math.random() * 6 + 3;
                        
                        context.beginPath();
                        context.arc(x, y, radius, 0, Math.PI * 2);
                        context.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.7 + 0.2})`;
                        context.fill();
                    }
                    break;
                case 'fireworks':
                    const gradient = context.createRadialGradient(
                        width/2, height/2, 0,
                        width/2, height/2, Math.min(width, height)/2
                    );
                    gradient.addColorStop(0, 'rgba(212, 175, 55, 0.1)');
                    gradient.addColorStop(0.5, 'rgba(245, 158, 11, 0.1)');
                    gradient.addColorStop(1, 'transparent');
                    
                    context.fillStyle = gradient;
                    context.fillRect(0, 0, width, height);
                    break;
                case 'festive':
                    const festiveGradient = context.createLinearGradient(0, 0, width, height);
                    festiveGradient.addColorStop(0, 'rgba(30, 58, 138, 0.1)');
                    festiveGradient.addColorStop(1, 'rgba(124, 58, 237, 0.1)');
                    
                    context.fillStyle = festiveGradient;
                    context.fillRect(0, 0, width, height);
                    break;
            }
            
            context.globalCompositeOperation = 'source-over';
        }
        
        // Apply overlay to canvas
        function applyOverlayToCanvas(context, width, height) {
            context.globalAlpha = 0.15;
            
            switch(currentOverlay) {
                case 'fireworks':
                    for (let i = 0; i < 25; i++) {
                        const x = Math.random() * width;
                        const y = Math.random() * height;
                        const radius = Math.random() * 50 + 20;
                        const colors = ['#D4AF37', '#FFD700', '#FF6347', '#1E90FF'];
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        context.beginPath();
                        context.arc(x, y, radius, 0, Math.PI * 2);
                        context.fillStyle = color;
                        context.fill();
                    }
                    break;
                    
                case 'confetti':
                    for (let i = 0; i < 60; i++) {
                        const x = Math.random() * width;
                        const y = Math.random() * height;
                        const size = Math.random() * 25 + 10;
                        const colors = ['#D4AF37', '#FFD700', '#FF6347', '#1E90FF', '#32CD32'];
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        context.fillStyle = color;
                        
                        if (Math.random() > 0.5) {
                            context.beginPath();
                            context.arc(x, y, size/2, 0, Math.PI * 2);
                            context.fill();
                        } else {
                            context.fillRect(x - size/2, y - size/2, size, size);
                        }
                    }
                    break;
                    
                case 'gold':
                    const goldGradient = context.createLinearGradient(0, 0, width, height);
                    goldGradient.addColorStop(0, 'rgba(212, 175, 55, 0.15)');
                    goldGradient.addColorStop(0.5, 'rgba(255, 215, 0, 0.15)');
                    goldGradient.addColorStop(1, 'rgba(255, 140, 0, 0.15)');
                    
                    context.fillStyle = goldGradient;
                    context.fillRect(0, 0, width, height);
                    break;
                    
                case 'sparkle':
                    for (let i = 0; i < 120; i++) {
                        const x = Math.random() * width;
                        const y = Math.random() * height;
                        const radius = Math.random() * 5 + 2;
                        
                        context.beginPath();
                        context.arc(x, y, radius, 0, Math.PI * 2);
                        context.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.3})`;
                        context.fill();
                    }
                    break;
            }
            
            context.globalAlpha = 1.0;
        }
        
        // Update UI after capture - FIXED for proper preview display
        function updateCaptureUI() {
            photoCounterText.textContent = `${photoCount}/4 Photos`;
            
            const layoutOptions = document.querySelectorAll('.mobile-option[data-layout]');
            layoutOptions.forEach(option => {
                const cells = option.querySelectorAll('.layout-cell');
                cells.forEach((cell, index) => {
                    if (index < photoCount) {
                        cell.classList.add('filled');
                        // Use a timeout to ensure the image is loaded
                        setTimeout(() => {
                            if (capturedPhotos[index]) {
                                // Create an image object to ensure proper loading
                                const img = new Image();
                                img.onload = function() {
                                    cell.style.backgroundImage = `url(${capturedPhotos[index].data})`;
                                };
                                img.src = capturedPhotos[index].data;
                            }
                        }, 50);
                    } else {
                        cell.classList.remove('filled');
                        cell.style.backgroundImage = '';
                    }
                });
            });
            
            if (photoCount >= 4) {
                captureBtn.innerHTML = '<i class="fas fa-check-circle"></i>';
                captureBtn.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                captureBtn.style.boxShadow = '0 4px 15px rgba(16, 185, 129, 0.8), 0 0 20px rgba(212, 175, 55, 0.4) inset';
                showToast('All photos captured! Scroll down to see collage.', 3000);
                
                // Scroll to collage
                setTimeout(() => {
                    photoCollage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 1000);
            } else {
                captureBtn.innerHTML = '<i class="fas fa-camera"></i>';
                captureBtn.style.background = 'radial-gradient(circle, var(--new-year-red) 0%, #8B0000 100%)';
                captureBtn.style.boxShadow = '0 4px 15px rgba(220, 38, 38, 0.8), 0 0 20px rgba(212, 175, 55, 0.4) inset';
            }
        }
        
        // Show optimized collage - FIXED for proper rendering
        function showCollage() {
            collageDisplay.innerHTML = '';
            // Apply the correct layout class
            collageDisplay.className = 'collage-display collage-layout-' + currentLayout;
            
            // Create cells based on layout
            const cellCount = 4;
            for (let i = 0; i < cellCount; i++) {
                const cell = document.createElement('div');
                cell.className = 'collage-cell';
                
                if (capturedPhotos[i]) {
                    // Create an image object to ensure proper loading
                    const img = new Image();
                    img.onload = function() {
                        cell.style.backgroundImage = `url(${capturedPhotos[i].data})`;
                    };
                    img.src = capturedPhotos[i].data;
                }
                
                const cellNumber = document.createElement('div');
                cellNumber.className = 'cell-number';
                cellNumber.textContent = i + 1;
                cell.appendChild(cellNumber);
                
                collageDisplay.appendChild(cell);
            }
            
            photoCollage.classList.add('active');
            
            setTimeout(() => {
                photoCollage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            showToast('Your 2027 photobooth collage is ready! Download your keepsake.', 3000);
        }
        
        // Initialize overlays - Fixed for mobile touch
        function initOverlays() {
            const overlays = [
                { id: 'fireworks', name: 'Fireworks', className: 'overlay-fireworks', icon: '' },
                { id: 'confetti', name: 'Confetti', className: 'overlay-confetti', icon: '' },
                { id: 'gold', name: 'Golden Glow', className: 'overlay-gold', icon: '' },
                { id: 'sparkle', name: 'Sparkle Magic', className: 'overlay-sparkle', icon: '' }
            ];
            
            const overlaysGrid = document.getElementById('overlays-grid');
            
            overlays.forEach(overlay => {
                const overlayElement = document.createElement('div');
                overlayElement.className = `mobile-option btn-tap-fix ${overlay.id === 'fireworks' ? 'active' : ''}`;
                overlayElement.dataset.overlay = overlay.id;
                overlayElement.setAttribute('aria-label', `Apply ${overlay.name} overlay`);
                overlayElement.setAttribute('role', 'button');
                overlayElement.tabIndex = 0;
                
                overlayElement.innerHTML = `
                    <div class="overlay-preview ${overlay.className}">
                        <div class="overlay-preview-content">
                            <span class="overlay-icon">${overlay.icon}</span>
                        </div>
                    </div>
                    <div class="option-name">${overlay.name}</div>
                `;
                
                // Enhanced click/touch handler
                const selectOverlay = () => {
                    document.querySelectorAll('.mobile-option[data-overlay]').forEach(o => {
                        o.classList.remove('active');
                    });
                    
                    overlayElement.classList.add('active');
                    currentOverlay = overlay.id;
                    startFireworksAnimation();
                    showToast(`${overlay.name} overlay applied`);
                    
                    // Visual feedback
                    overlayElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        overlayElement.style.transform = '';
                    }, 150);
                };
                
                // Multiple event listeners for maximum compatibility
                overlayElement.addEventListener('click', selectOverlay);
                overlayElement.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    selectOverlay();
                });
                
                // Add keyboard support
                overlayElement.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectOverlay();
                    }
                });
                
                overlaysGrid.appendChild(overlayElement);
            });
        }
        
        // Initialize filters - Fixed for mobile touch
        function initFilters() {
            const filters = [
                { id: 'none', name: 'Classic', color: 'filter-none', icon: '' },
                { id: 'gold', name: 'Golden', color: 'filter-gold', icon: '' },
                { id: 'silver', name: 'Silver', color: 'filter-silver', icon: '' },
                { id: 'sparkle', name: 'Sparkle', color: 'filter-sparkle', icon: '' },
                { id: 'fireworks', name: 'Fireworks', color: 'filter-fireworks', icon: '' },
                { id: 'festive', name: 'Festive', color: 'filter-festive', icon: '' }
            ];
            
            const filtersGrid = document.getElementById('filters-grid');
            
            filters.forEach(filter => {
                const filterElement = document.createElement('div');
                filterElement.className = `mobile-option btn-tap-fix ${filter.id === 'none' ? 'active' : ''}`;
                filterElement.dataset.filter = filter.id;
                filterElement.setAttribute('aria-label', `Apply ${filter.name} filter`);
                filterElement.setAttribute('role', 'button');
                filterElement.tabIndex = 0;
                
                filterElement.innerHTML = `
                    <div class="filter-preview ${filter.color}">
                        <span class="filter-icon">${filter.icon}</span>
                    </div>
                    <div class="option-name">${filter.name}</div>
                `;
                
                // Enhanced click/touch handler
                const selectFilter = () => {
                    document.querySelectorAll('.mobile-option[data-filter]').forEach(f => {
                        f.classList.remove('active');
                    });
                    
                    filterElement.classList.add('active');
                    currentFilter = filter.id;
                    showToast(`${filter.name} filter applied`);
                    
                    // Visual feedback
                    filterElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        filterElement.style.transform = '';
                    }, 150);
                };
                
                // Multiple event listeners for maximum compatibility
                filterElement.addEventListener('click', selectFilter);
                filterElement.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    selectFilter();
                });
                
                // Add keyboard support
                filterElement.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectFilter();
                    }
                });
                
                filtersGrid.appendChild(filterElement);
            });
        }
        
        // Initialize layout options - Fixed for mobile touch and preview
        function initLayouts() {
            const layouts = [
                { id: '2x2', name: 'Classic Grid', className: 'layout-2x2' },
                { id: '1x4', name: 'Horizontal', className: 'layout-1x4' },
                { id: '3-1', name: 'Large Top', className: 'layout-3-1' },
                { id: '1-3', name: 'Large Bottom', className: 'layout-1-3' }
            ];
            
            const layoutsContainer = document.getElementById('collage-layouts');
            
            layouts.forEach(layout => {
                const layoutElement = document.createElement('div');
                layoutElement.className = `mobile-option btn-tap-fix ${layout.id === '2x2' ? 'active' : ''}`;
                layoutElement.dataset.layout = layout.id;
                layoutElement.setAttribute('aria-label', `Select ${layout.name} layout`);
                layoutElement.setAttribute('role', 'button');
                layoutElement.tabIndex = 0;
                
                layoutElement.innerHTML = `
                    <div class="layout-preview ${layout.className}">
                        <div class="layout-cell"></div>
                        <div class="layout-cell"></div>
                        <div class="layout-cell"></div>
                        <div class="layout-cell"></div>
                    </div>
                    <div class="option-name">${layout.name}</div>
                `;
                
                // Enhanced click/touch handler
                const selectLayout = () => {
                    document.querySelectorAll('.mobile-option[data-layout]').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    layoutElement.classList.add('active');
                    currentLayout = layout.id;
                    showToast(`${layout.name} layout selected`);
                    
                    // Visual feedback
                    layoutElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        layoutElement.style.transform = '';
                    }, 150);
                    
                    if (photoCount >= 4) {
                        showCollage();
                    }
                };
                
                // Multiple event listeners for maximum compatibility
                layoutElement.addEventListener('click', selectLayout);
                layoutElement.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    selectLayout();
                });
                
                // Add keyboard support
                layoutElement.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectLayout();
                    }
                });
                
                layoutsContainer.appendChild(layoutElement);
            });
        }
        
        // Download collage with perfect 4x6 size - UPDATED
        function downloadCollage() {
            if (capturedPhotos.length < 4) {
                showToast('Please capture 4 photos first!', 2000);
                return;
            }
            
            showToast('Creating your premium 4x6 collage...', 1500);
            
            // Create canvas for final image
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // EXACT 4x6 inch dimensions at 300 DPI for perfect printing
            canvas.width = 1200;  // 4 inches * 300 DPI
            canvas.height = 1800; // 6 inches * 300 DPI
            
            // Draw background
            const backgroundGradient = context.createLinearGradient(0, 0, canvas.width, canvas.height);
            backgroundGradient.addColorStop(0, '#0a0e1a');
            backgroundGradient.addColorStop(0.5, '#1a2b5a');
            backgroundGradient.addColorStop(1, '#3a1b6a');
            context.fillStyle = backgroundGradient;
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add subtle texture
            context.globalAlpha = 0.03;
            for (let i = 0; i < 400; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 2 + 1;
                
                context.beginPath();
                context.arc(x, y, radius, 0, Math.PI * 2);
                context.fillStyle = '#FFFFFF';
                context.fill();
            }
            context.globalAlpha = 1.0;
            
            // Add decorative border
            const borderGradient = context.createLinearGradient(0, 0, canvas.width, 0);
            borderGradient.addColorStop(0, '#D4AF37');
            borderGradient.addColorStop(0.5, '#FFD700');
            borderGradient.addColorStop(1, '#D4AF37');
            
            context.strokeStyle = borderGradient;
            context.lineWidth = 15;
            context.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            
            // Add corner decorations
            const cornerSize = 30;
            context.strokeStyle = '#D4AF37';
            context.lineWidth = 5;
            
            // Draw all four corners
            [[30, 30], [canvas.width - 30, 30], [30, canvas.height - 30], [canvas.width - 30, canvas.height - 30]].forEach(([x, y], index) => {
                context.save();
                context.translate(x, y);
                if (index === 1) context.rotate(Math.PI / 2);
                if (index === 2) context.rotate(-Math.PI / 2);
                if (index === 3) context.rotate(Math.PI);
                
                context.beginPath();
                context.moveTo(0, cornerSize);
                context.lineTo(0, 0);
                context.lineTo(cornerSize, 0);
                context.stroke();
                context.restore();
            });
            
            // Title with gradient
            context.font = 'bold 70px "Dancing Script", cursive';
            
            const titleGradient = context.createLinearGradient(0, 100, canvas.width, 100);
            titleGradient.addColorStop(0, '#D4AF37');
            titleGradient.addColorStop(0.5, '#FFD700');
            titleGradient.addColorStop(1, '#D4AF37');
            
            context.fillStyle = titleGradient;
            context.textAlign = 'center';
            context.shadowColor = 'rgba(0, 0, 0, 0.7)';
            context.shadowBlur = 10;
            context.fillText('Happy New Year', canvas.width / 2, 120);
            context.shadowBlur = 0;
            
            // Year display
            context.font = 'bold 90px "Playfair Display", serif';
            context.fillStyle = '#D4AF37';
            context.textAlign = 'center';
            context.shadowColor = 'rgba(0, 0, 0, 0.6)';
            context.shadowBlur = 12;
            context.fillText('2027', canvas.width / 2, canvas.height - 80);
            context.shadowBlur = 0;
            
            // Subtitle
            context.font = 'bold 25px "Montserrat", sans-serif';
            context.fillStyle = 'rgba(255, 255, 255, 0.9)';
            context.textAlign = 'center';
            context.fillText('Dela Cruz Family Celebration', canvas.width / 2, 170);
            
            // Collage positioning - centered on 4x6 canvas
            const collageMargin = 40;
            const collageWidth = canvas.width - (collageMargin * 2);
            const collageHeight = 1000; // Fixed height for collage area
            const collageStartX = collageMargin;
            const collageStartY = 220; // Position after title
            
            // Draw collage background
            context.fillStyle = 'rgba(0, 0, 0, 0.3)';
            context.fillRect(collageStartX - 15, collageStartY - 15, collageWidth + 30, collageHeight + 30);
            
            // Calculate cell positions based on layout
            const cellPositions = get4x6CellPositions(currentLayout, collageWidth, collageHeight);
            
            let imagesLoaded = 0;
            const totalImages = Math.min(4, capturedPhotos.length);
            
            if (totalImages === 0) {
                showToast('No photos to download!', 2000);
                return;
            }
            
            // Load all images
            const images = [];
            let loadedImages = 0;
            
            capturedPhotos.forEach((photo, index) => {
                if (index < 4) {
                    const img = new Image();
                    img.onload = function() {
                        images[index] = img;
                        loadedImages++;
                        
                        if (loadedImages === totalImages) {
                            drawCollageToCanvas();
                        }
                    };
                    img.onerror = function() {
                        console.error('Error loading image for collage');
                        loadedImages++;
                        if (loadedImages === totalImages) {
                            drawCollageToCanvas();
                        }
                    };
                    img.src = photo.data;
                }
            });
            
            function drawCollageToCanvas() {
                // Draw each cell without stretching
                cellPositions.forEach((pos, index) => {
                    if (images[index]) {
                        // Calculate aspect ratios
                        const imgAspect = images[index].width / images[index].height;
                        const cellAspect = pos.width / pos.height;
                        
                        let drawWidth, drawHeight, drawX, drawY;
                        
                        if (imgAspect > cellAspect) {
                            // Image is wider than cell
                            drawHeight = pos.height;
                            drawWidth = drawHeight * imgAspect;
                            drawX = collageStartX + pos.x + (pos.width - drawWidth) / 2;
                            drawY = collageStartY + pos.y;
                        } else {
                            // Image is taller than cell
                            drawWidth = pos.width;
                            drawHeight = drawWidth / imgAspect;
                            drawX = collageStartX + pos.x;
                            drawY = collageStartY + pos.y + (pos.height - drawHeight) / 2;
                        }
                        
                        // Draw cell with shadow
                        context.shadowColor = 'rgba(0, 0, 0, 0.4)';
                        context.shadowBlur = 8;
                        context.shadowOffsetY = 5;
                        
                        // Draw the image without stretching
                        context.drawImage(
                            images[index], 
                            drawX, drawY, drawWidth, drawHeight
                        );
                        
                        context.shadowBlur = 0;
                        context.shadowOffsetY = 0;
                        
                        // Draw cell border
                        const cellBorderGradient = context.createLinearGradient(
                            collageStartX + pos.x, 
                            collageStartY + pos.y,
                            collageStartX + pos.x + pos.width,
                            collageStartY + pos.y + pos.height
                        );
                        cellBorderGradient.addColorStop(0, '#D4AF37');
                        cellBorderGradient.addColorStop(0.5, '#FFD700');
                        cellBorderGradient.addColorStop(1, '#D4AF37');
                        
                        context.strokeStyle = cellBorderGradient;
                        context.lineWidth = 4;
                        context.strokeRect(
                            collageStartX + pos.x, 
                            collageStartY + pos.y, 
                            pos.width, 
                            pos.height
                        );
                        
                        // Draw photo number
                        context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        context.beginPath();
                        context.arc(
                            collageStartX + pos.x + 25, 
                            collageStartY + pos.y + 25, 
                            20, 0, Math.PI * 2
                        );
                        context.fill();
                        
                        context.font = 'bold 16px "Montserrat", sans-serif';
                        context.fillStyle = '#D4AF37';
                        context.textAlign = 'center';
                        context.textBaseline = 'middle';
                        context.fillText(
                            index + 1, 
                            collageStartX + pos.x + 25, 
                            collageStartY + pos.y + 25
                        );
                    }
                });
                
                // Add decorative elements
                const decorations = ['', '', '', '', '', ''];
                context.font = '35px Arial';
                context.fillStyle = '#D4AF37';
                context.textAlign = 'center';
                
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    const radius = 150;
                    const x = canvas.width / 2 + Math.cos(angle) * radius;
                    const y = collageStartY + collageHeight / 2 + Math.sin(angle) * radius;
                    
                    context.save();
                    context.translate(x, y);
                    context.rotate(angle);
                    context.fillText(decorations[i], 0, 0);
                    context.restore();
                }
                
                // Footer text
                context.font = '18px "Montserrat", sans-serif';
                context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                context.textAlign = 'center';
                context.fillText('Premium Photobooth 2027  Dela Cruz Family', canvas.width / 2, canvas.height - 40);
                context.fillText('Perfectly sized for 4x6 inch photo prints', canvas.width / 2, canvas.height - 15);
                
                // Trigger download
                try {
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                    link.download = `dela-cruz-2027-4x6-collage-${timestamp}.jpg`;
                    
                    // Convert to data URL with high quality for printing
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                    link.href = dataUrl;
                    
                    // Use a timeout to ensure everything is ready
                    setTimeout(() => {
                        link.click();
                        showToast('4x6 photobooth collage downloaded! Ready for printing.', 3000);
                    }, 100);
                    
                } catch (e) {
                    console.error('Error downloading image:', e);
                    showToast('Error downloading collage. Please try again.', 3000);
                }
            }
        }
        
        // Get cell positions for 4x6 layout - UPDATED for perfect fit
        function get4x6CellPositions(layout, containerWidth, containerHeight) {
            const positions = [];
            const spacing = 10; // Minimal spacing for 4x6 layout
            
            switch(layout) {
                case '2x2':
                    const cellWidth2x2 = (containerWidth - spacing) / 2;
                    const cellHeight2x2 = (containerHeight - spacing) / 2;
                    
                    for (let row = 0; row < 2; row++) {
                        for (let col = 0; col < 2; col++) {
                            positions.push({
                                x: col * (cellWidth2x2 + spacing/2),
                                y: row * (cellHeight2x2 + spacing/2),
                                width: cellWidth2x2,
                                height: cellHeight2x2
                            });
                        }
                    }
                    break;
                    
                case '1x4':
                    const cellWidth1x4 = (containerWidth - spacing * 3) / 4;
                    
                    for (let i = 0; i < 4; i++) {
                        positions.push({
                            x: i * (cellWidth1x4 + spacing),
                            y: spacing,
                            width: cellWidth1x4,
                            height: containerHeight - spacing * 2
                        });
                    }
                    break;
                    
                case '3-1':
                    const topHeight = ((containerHeight - spacing) * 2) / 3;
                    const bottomHeight = (containerHeight - spacing) / 3;
                    const topWidth = (containerWidth - spacing) / 2;
                    const bottomWidth = (containerWidth - spacing) / 2;
                    
                    positions.push({ x: 0, y: 0, width: topWidth, height: topHeight });
                    positions.push({ x: topWidth + spacing/2, y: 0, width: topWidth, height: topHeight });
                    positions.push({ x: 0, y: topHeight + spacing/2, width: bottomWidth, height: bottomHeight });
                    positions.push({ x: bottomWidth + spacing/2, y: topHeight + spacing/2, width: bottomWidth, height: bottomHeight });
                    break;
                    
                case '1-3':
                    const topHeight2 = (containerHeight - spacing) / 3;
                    const bottomHeight2 = ((containerHeight - spacing) * 2) / 3;
                    const topWidth2 = (containerWidth - spacing) / 2;
                    const bottomWidth2 = (containerWidth - spacing) / 2;
                    
                    positions.push({ x: 0, y: 0, width: topWidth2, height: topHeight2 });
                    positions.push({ x: topWidth2 + spacing/2, y: 0, width: topWidth2, height: topHeight2 });
                    positions.push({ x: 0, y: topHeight2 + spacing/2, width: bottomWidth2, height: bottomHeight2 });
                    positions.push({ x: bottomWidth2 + spacing/2, y: topHeight2 + spacing/2, width: bottomWidth2, height: bottomHeight2 });
                    break;
            }
            
            return positions;
        }
        
        // Reset photobooth
        function resetPhotobooth() {
            capturedPhotos = [];
            photoCount = 0;
            
            document.querySelectorAll('.layout-cell').forEach(cell => {
                cell.classList.remove('filled');
                cell.style.backgroundImage = '';
            });
            
            updateCaptureUI();
            photoCollage.classList.remove('active');
            
            setTimeout(() => {
                document.querySelector('.camera-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 150);
            
            showToast('Photobooth reset! Ready for new memories.', 2000);
        }
        
        // Toggle grid visibility
        function toggleGrid() {
            gridVisible = !gridVisible;
            if (gridVisible) {
                aspectRatioGuide.style.display = 'block';
                toggleGridBtn.innerHTML = '<i class="fas fa-th"></i>';
                toggleGridBtn.style.color = '#D4AF37';
                showToast('4x6 framing guide enabled');
            } else {
                aspectRatioGuide.style.display = 'none';
                toggleGridBtn.innerHTML = '<i class="fas fa-th-large"></i>';
                toggleGridBtn.style.color = 'white';
                showToast('Framing guide disabled');
            }
        }
        
        // Initialize the app - Enhanced for mobile experience
        document.addEventListener('DOMContentLoaded', function() {
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // Initialize UI components first
            initOverlays();
            initFilters();
            initLayouts();
            
            // Enhanced event listeners with better mobile support
            captureBtn.addEventListener('click', capturePhoto);
            captureBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                capturePhoto();
            });
            
            switchCameraBtn.addEventListener('click', function() {
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                initCamera();
                showToast(facingMode === 'user' ? 'Front camera activated' : 'Rear camera activated');
            });
            
            switchCameraBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                initCamera();
                showToast(facingMode === 'user' ? 'Front camera activated' : 'Rear camera activated');
            });
            
            toggleFlashBtn.addEventListener('click', function() {
                flashOn = !flashOn;
                this.innerHTML = flashOn ? '<i class="fas fa-bolt" style="color: #D4AF37;"></i>' : '<i class="fas fa-bolt"></i>';
                showToast(flashOn ? 'Flash enabled' : 'Flash disabled');
            });
            
            toggleFlashBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                flashOn = !flashOn;
                this.innerHTML = flashOn ? '<i class="fas fa-bolt" style="color: #D4AF37;"></i>' : '<i class="fas fa-bolt"></i>';
                showToast(flashOn ? 'Flash enabled' : 'Flash disabled');
            });
            
            toggleGridBtn.addEventListener('click', toggleGrid);
            toggleGridBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                toggleGrid();
            });
            
            downloadBtn.addEventListener('click', downloadCollage);
            downloadBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                downloadCollage();
            });
            
            resetBtn.addEventListener('click', resetPhotobooth);
            resetBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                resetPhotobooth();
            });
            
            // Enhanced touch event handlers for better mobile experience
            document.querySelectorAll('.btn-tap-fix, .mobile-option').forEach(btn => {
                // Prevent text selection on tap
                btn.style.userSelect = 'none';
                btn.style.webkitUserSelect = 'none';
                
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.transform = 'scale(0.95)';
                }, { passive: false });
                
                btn.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
                
                // Prevent context menu on long press
                btn.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
            });
            
            // Initialize camera after a short delay
            setTimeout(() => {
                initCamera();
                
                // Show welcome message
                setTimeout(() => {
                    showToast('Welcome to Dela Cruz 2027 Photobooth! Photos optimized for 4x6 printing.', 3000);
                }, 1200);
            }, 500);
            
            // Add event listener for page visibility to handle iOS camera issues
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Page is hidden, stop camera
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraStream = null;
                        cameraReady = false;
                    }
                } else {
                    // Page is visible again, restart camera after a delay
                    setTimeout(initCamera, 500);
                }
            });
            
            // Handle page unload to clean up camera
            window.addEventListener('beforeunload', function() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            });
            
            // Add smooth scrolling for better mobile experience
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Add scroll listener to hide indicator
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                // Clear previous timeout
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                // Hide indicator after scrolling
                scrollTimeout = setTimeout(() => {
                    if (scrollIndicator && window.scrollY > 100) {
                        scrollIndicator.style.display = 'none';
                    }
                }, 1000);
            });
        });
    </script>
</body>
</html>
